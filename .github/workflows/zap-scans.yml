name: OWASP ZAP Scan

on:
  push:
    branches:
      - main  # Adjust the branch name as needed
  pull_request:

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    permissions: write-all
    strategy:
      matrix:
        node-version: [18.x]
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node-version }}

      - name: Get npm cache directory
        id: myCacheStep
        shell: bash
        run: echo "dir=$(npm config get cache)" >> ${GITHUB_ENV}

      - name: Cache node modules
        id: npm-cache 
        uses: actions/cache@v2
        env:
          cache-name: cache-node-modules
        with: 
          path: node_modules
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-
            ${{ runner.os }}-build-
            ${{ runner.os }}-

      - name: Install Dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm install         

      - name: Start API server
        run: npm run start & sleep 5
        
      - name: Run DAST Scan
        run: |
          docker pull owasp/zap2docker-weekly
          docker run -v $(pwd):/zap/wrk/:rw -t owasp/zap2docker-weekly zap-api-scan.py \
          -t openapi.json \
          -f openapi \
          -r api-active-scan.html \
          -z "-config replacer.full_list(0).description=auth1 \
              -config replacer.full_list(0).enabled=true \
              -config replacer.full_list(0).matchtype=REQ_HEADER \
              -config replacer.full_list(0).matchstr=x-auth-token \
              -config replacer.full_list(0).regex=false \
              -config replacer.full_list(0).replacement=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6ImYyOTMxYjg1LWU5NGUtNDY4MS04ZWM4LWFkOTQyZDNmM2MwZiIsImVtYWlsIjoibW9oaXRiaGFyZHdhakBnbWFpbC5jb20iLCJwYXNzd29yZCI6IiQyYiQxMCRZZ0daR2g2LlZqSmFIcHhRQzJoYXhlajFZdVV5eU8wLllhaHA1VE0wckxXWmJFdDBKaGN4TyIsImlhdCI6MTY4ODk2OTQ0MX0.2YPQA5dyZ6cu51Cdq2x3NkH3a7XdBQqikMVlskVqXHo"